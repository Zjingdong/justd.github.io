---
# layout: post
# title: 'Idea常用快捷键'
# date: 2018-10-10
# author: Justd
# cover: '/assets/img/2018-10/10/post-bg-idea.jpg'
# tags: Idea 快捷键  
---
# 一条SQL查询语句的执行过程   

>来源于极客时间《MySQL实战》  

最近刚刚购买了极客时间的课程《MySQL实战45讲》，我会在这里将学习到的知识点做一个总结。   

本节主要是讲MySQL的基础架构。比如执行以下语句时：
```SQL  
mysql> select * from T where ID=10;
```   
这条语句在MySQL内部是如何处理的。


## 基础架构图

![](/assets/img/2018-11/20/mysql1.png)    
如图 主体分为两部分:Server和存储引擎部分。

Server包括：连接器、缓存查询、分析器、优化器、执行器。存储过程、触发器、视图等功能都在Server层处理。   

存储引擎负责数据的存储和提取。常见的有InnoDB、MyISAM。


## 连接器   

连接器与客户端建立连接、获取权限、维持和管理连接。

  
 常见的命令：
 > mysql -uroot -ppassword      

 用来和服务器建立连接，TCP握手后完成认证过程。
 - 账号密码不对，报错："Access denied for user"
 - 认证通过，在权限表中查询拥有的权限    

只有在连接过程才会从权限表中读取权限信息，中途对权限的修改不会影响已经建立的连接，只有重新登陆后才会使用新的权限信息。

建立连接后如果长时间处于空闲状态，``"show processlist"``  命令可以看到到处于sleep状态的连接。   
若规定时间内无活动，则会自动断开连接。**规定时间** 由 ``wait_timeout``控制，默认为8小时。断开后，再次发请回会提示   `"Lost connection to MySQL server during query"` ,只能重新连接。   

防止数据库中出现占用大量内存的情况，可以用一下方法解决：   
1. 定期断开长连接或者占用内存过大的连接。
2. MySQL5.7及以上版本，每次执行一个较大的操作，可执行 `"mysql_reset_connection"`命令来初始化连接资源，该操作不会重连和重新获取授权，只是恢复到刚建立连接的状态。   
   
 
## 查询缓存   
建立连接后，就可以执行select操作，这是会执行第二部分：查询缓存。   

一个请求进来，首先查询缓存，是否存在该记录。之前执行过的语句，则会以语句为key,执行后的结果集为value存储在内存中。
- 如果在缓存中查找到，则回直接返回给客户端。 
- 如果没有找到记录，继续执行后面的操作，并将该语句与结果分别以key-value存入内存。
  
**不建议使用查询缓存，此操作弊大于利  ( MySQL8.0后将会删除该功能 )**    
>对于一个表，只要有更新便会将涉及到该表的缓存全部清空。   
只适用于不常更新的静态表   
推荐：   
   -将query_cache_type 设置为 DEMAND,默认SQL不使用查询缓存，针对需要查询缓存的语句，使用SQL_cache显示指定，例如：   
 ```sql
select SQL_CACHE * from T where ID = 10;
```

## 分析器    
>这条SQL要做什么    

1. 词法分析   
识别SQL关键字，提出主要成分。MySQL根据`"select"`得出这是一条查询语句，根据`"from T"`识别表T，将`"ID"`识别为列名。   
2. 语法分析    
根据语法规则判断是否符合SQL的语法。如果出现错误，则提示：`"You have an error in your SQL syntax..."`,后面是错误的地方，需要你关注`"use naer"`后的内容。  

## 优化器
>这条SQL如何做   

这个步骤将会选取最优的执行方式，例如：   
1. 当涉及到多个索引时，决定用哪个索引   
2. 多表关联时，决定连接顺序
    ```sql
    select * from t1 join t2 using(ID) where t1.c=10 and t2.d=20;
    ```
    该步骤决定了先从t1表中取出c=10的ID值还是先查找出t2表中d=20的ID值。

## 执行器    
>真正的执行步骤

//to-do


